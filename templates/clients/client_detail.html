<!-- templates/clients/client_detail.html -->
{% extends "base.html" %}

{% block content %}
    <div class="container mt-4">
        <h2>Данные о клиенте</h2>

        <!-- Информация о клиенте -->
        <p><strong>Имя:</strong> <span id="clientName"></span></p>
        <p><strong>Номер:</strong> <span id="clientNumber"></span></p>
        <p><strong>Город:</strong> <span id="clientCity"></span></p>
        <p><strong>Код:</strong> <span id="clientCode"></span></p>

        <!-- Товары клиента -->
        <h3>Товары клиента</h3>
        <table class="table table-striped" id="productsTable">
            <thead>
                <tr>
                    <th>Код товара</th>
                    <th>Вес</th>
                    <th>Цена</th>
                    <th>Дата</th>
                    <th>Статус</th>
                    <th>Филиал</th>
                </tr>
            </thead>
            <tbody id="productsTableBody"></tbody>
        </table>

        <a href="/clients/" class="btn btn-secondary">Назад</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SiteUrl = "{{ site_url_and_port }}";
        const token = "{{ token }}";
        const clientId = window.location.pathname.split('/')[2]; // Извлекаем ID из URL (/clients/2)

        // Загрузка данных клиента, товаров, статусов и филиалов
        async function loadClientData() {
            try {
                // Загрузка данных клиента и товаров
                const clientResponse = await fetch(`${SiteUrl}/clients/${clientId}/data`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });
                if (!clientResponse.ok) throw new Error(`Ошибка клиента: ${clientResponse.status}`);
                const clientData = await clientResponse.json();

                // Загрузка всех статусов
                const statusesResponse = await fetch(`${SiteUrl}/statuses/?skip=0&limit=100`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });
                if (!statusesResponse.ok) throw new Error(`Ошибка статусов: ${statusesResponse.status}`);
                const statuses = await statusesResponse.json();

                // Загрузка всех филиалов
                const branchesResponse = await fetch(`${SiteUrl}/branches/?skip=0&limit=100`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });
                if (!branchesResponse.ok) throw new Error(`Ошибка филиалов: ${branchesResponse.status}`);
                const branches = await branchesResponse.json();

                // Рендеринг данных
                renderClientData(clientData, statuses, branches);
            } catch (error) {
                console.error("Ошибка при загрузке данных:", error);
                document.getElementById("clientName").textContent = "Ошибка загрузки данных";
            }
        }

        // Рендеринг данных клиента и товаров
        function renderClientData(clientData, statuses, branches) {
            // Данные клиента
            document.getElementById("clientName").textContent = clientData.name || "";
            document.getElementById("clientNumber").textContent = clientData.number || "";
            document.getElementById("clientCity").textContent = clientData.city || "";
            document.getElementById("clientCode").textContent = clientData.code || "";

            // Создание словарей для статусов и филиалов
            const statusMap = statuses.reduce((map, status) => {
                map[status.id] = status.name;
                return map;
            }, {});
            const branchMap = branches.reduce((map, branch) => {
                map[branch.id] = branch.name;
                return map;
            }, {});

            // Рендеринг товаров
            const tbody = document.getElementById("productsTableBody");
            tbody.innerHTML = "";
            if (clientData.products && clientData.products.length > 0) {
                clientData.products.forEach(product => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td><a href="/products/detail/${product.id}">${product.product_code}</a></td>
                        <td>${product.weight || ""}</td>
                        <td>${product.price || ""}</td>
                        <td>${new Date(product.date).toLocaleDateString("ru-RU", {year: "numeric", month: "2-digit", day: "2-digit"})}</td>
                        <td>${statusMap[product.status_id] || ""}</td>
                        <td>${branchMap[product.branch_id] || ""}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = "<tr><td colspan='6'>У клиента нет товаров.</td></tr>";
            }
        }

        // Начальная загрузка
        loadClientData();
    </script>
{% endblock %}