{% extends "base.html" %}

{% block content %}
    <div class="container mt-5">
        <p class="fs-4">Добавить товары Китай</p>

        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
        <div id="successMessage" class="alert alert-info" style="display: none;"></div>

        <form id="uploadForm" class="mt-5" enctype="multipart/form-data">
            <div class="input-group mb-3">
                <input type="file" name="file" class="form-control" id="inputGroupFile02" required>
                <label class="input-group-text" for="inputGroupFile02">Загрузить</label>
            </div>
            <button class="btn btn-primary" type="submit">Добавить</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SiteUrl = "{{ site_url_and_port }}";
        const token = "{{ token }}";

        document.getElementById("uploadForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const file = formData.get("file");

            if (!file || file.size === 0) {
                const errorDiv = document.getElementById("errorMessage");
                errorDiv.textContent = "Файл не выбран.";
                errorDiv.style.display = "block";
                return;
            }

            // Читаем содержимое файла на клиенте
            const fileReader = new FileReader();
            fileReader.onload = async function(event) {
                const fileContent = event.target.result;

                // Отправляем файл в API для обработки
                const processFormData = new FormData();
                processFormData.append("file_content", new Blob([fileContent]));

                try {
                    const response = await fetch(`${SiteUrl}/products/process-china`, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${token}`
                        },
                        body: processFormData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Ошибка: ${response.status} - ${JSON.stringify(errorData)}`);
                    }

                    const successDiv = document.getElementById("successMessage");
                    successDiv.textContent = "Обработка файла запущена. Результаты будут доступны позже.";
                    successDiv.style.display = "block";
                    document.getElementById("errorMessage").style.display = "none";
                } catch (error) {
                    console.error("Ошибка при загрузке файла:", error);
                    const errorDiv = document.getElementById("errorMessage");
                    errorDiv.textContent = "Не удалось загрузить файл: " + error.message;
                    errorDiv.style.display = "block";
                    document.getElementById("successMessage").style.display = "none";
                }
            };

            fileReader.onerror = function() {
                const errorDiv = document.getElementById("errorMessage");
                errorDiv.textContent = "Ошибка чтения файла.";
                errorDiv.style.display = "block";
            };

            fileReader.readAsArrayBuffer(file);
        });
    </script>
{% endblock %}