{% extends "base.html" %}

{% block content %}
{% include 'components/nav_user_config.html' %}

<div class="container mt-4">
    <!-- Add Video Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Добавить видео</h5>
        </div>
        <div class="card-body">
            <form id="add-video-form" enctype="multipart/form-data" onsubmit="return false;">
                <div class="row g-2 align-items-center">
                    <div class="col-md-4">
                        <input type="text" id="video-name" class="form-control" placeholder="Имя видео" required>
                    </div>
                    <div class="col-md-4">
                        <input type="file" id="video-file" class="form-control" accept="video/*" required>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="addVideo()">Добавить</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Video List -->
    <div class="card">
        <div class="card-header">
            <h5>Список видео</h5>
        </div>
        <div class="card-body p-0">
            <div id="list-videos" class="list-group list-group-flush"></div>
        </div>
    </div>
</div>

<!-- Edit Video Modal -->
<div class="modal fade" id="editVideoModal" tabindex="-1" aria-labelledby="editVideoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editVideoModalLabel">Изменить видео</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-video-form" enctype="multipart/form-data" onsubmit="return false;">
          <input type="hidden" id="edit-video-id">
          <input type="hidden" id="edit-video-current-url">
          <div class="mb-3">
            <label for="edit-video-name" class="form-label">Имя</label>
            <input type="text" class="form-control" id="edit-video-name" required>
          </div>
          <div class="mb-3">
            <label for="edit-video-file" class="form-label">Заменить файл (необязательно)</label>
            <input type="file" class="form-control" id="edit-video-file" accept="video/*">
          </div>
          <div class="mb-3">
            <video id="edit-video-preview" src="" controls style="max-width:120px;max-height:80px;border:1px solid #eee;"></video>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="edit-video-active">
            <label class="form-check-label" for="edit-video-active">Активно</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" onclick="submitEditVideo()">Сохранить</button>
      </div>
    </div>
  </div>
</div>

<!-- View Video Modal -->
<div class="modal fade" id="viewVideoModal" tabindex="-1" aria-labelledby="viewVideoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewVideoModalLabel">Просмотр видео</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <video id="view-video-player" src="" controls style="max-width:100%;max-height:60vh;"></video>
        <div class="mt-2" id="view-video-title"></div>
      </div>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const SiteURL = "{{site_url_and_port}}";
    const Token = "{{token}}";
    let editVideoModal;
    let viewVideoModal;
    document.addEventListener('DOMContentLoaded', function() {
        editVideoModal = new bootstrap.Modal(document.getElementById('editVideoModal'));
        viewVideoModal = new bootstrap.Modal(document.getElementById('viewVideoModal'));
    });

    async function fetchVideos() {
        try {
            const response = await fetch(`${SiteURL}/address-file/video`, {
                method: 'GET',
                headers: {
                    'accept': 'application/json',
                    'Authorization': `Bearer ${Token}`
                }
            });
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            const container = document.getElementById('list-videos');
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<div class="p-3 text-muted">Нет видео</div>';
                return;
            }
            data.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item d-flex align-items-center justify-content-between';
                listItem.innerHTML = `
                    <div class="d-flex align-items-center gap-3">
                        <span>${item.name}</span>
                        ${item.active ? '<span class="badge bg-success">active</span>' : ''}
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-success me-2" onclick="viewVideo('${item.url}', '${item.name.replace(/'/g, "&#39;")}')">Просмотр</button>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editVideo(${item.id}, '${item.name.replace(/'/g, "&#39;")}', '${item.url}', ${item.active})">Изменить</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteVideo(${item.id})">Удалить</button>
                    </div>
                `;
                container.appendChild(listItem);
            });
        } catch (error) {
            const container = document.getElementById('list-videos');
            container.innerHTML = '<div class="alert alert-danger">Ошибка загрузки видео</div>';
        }
    }

    async function addVideo() {
        const nameInput = document.getElementById('video-name');
        const fileInput = document.getElementById('video-file');
        const name = nameInput.value.trim();
        const file = fileInput.files[0];
        if (!name || !file) {
            alert('Заполните имя и выберите файл');
            return;
        }
        try {
            // 1. Upload file
            const formData = new FormData();
            formData.append('files', file);
            const uploadResp = await fetch(`${SiteURL}/storage/upload`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${Token}`
                },
                body: formData
            });
            if (!uploadResp.ok) throw new Error('Ошибка загрузки файла');
            const uploadData = await uploadResp.json();
            const url = uploadData.uploaded_urls[0];
            // 2. Add video record
            const addResp = await fetch(`${SiteURL}/address-file/video`, {
                method: 'POST',
                headers: {
                    'accept': 'application/json',
                    'Authorization': `Bearer ${Token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, url })
            });
            if (!addResp.ok) throw new Error('Ошибка добавления видео');
            nameInput.value = '';
            fileInput.value = '';
            fetchVideos();
        } catch (error) {
            alert(error.message || 'Ошибка добавления');
        }
    }

    function editVideo(id, currentName, currentUrl, currentActive = true) {
        document.getElementById('edit-video-id').value = id;
        document.getElementById('edit-video-name').value = currentName;
        document.getElementById('edit-video-current-url').value = currentUrl;
        document.getElementById('edit-video-preview').src = currentUrl;
        document.getElementById('edit-video-file').value = '';
        document.getElementById('edit-video-active').checked = currentActive;
        editVideoModal.show();
    }

    async function submitEditVideo() {
        const id = document.getElementById('edit-video-id').value;
        const name = document.getElementById('edit-video-name').value.trim();
        const fileInput = document.getElementById('edit-video-file');
        const file = fileInput.files[0];
        let url = document.getElementById('edit-video-current-url').value;
        const active = document.getElementById('edit-video-active').checked;
        if (!name) {
            alert('Имя обязательно');
            return;
        }
        try {
            if (file) {
                // Сначала загружаем новый файл
                const formData = new FormData();
                formData.append('files', file);
                const uploadResp = await fetch(`${SiteURL}/storage/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${Token}`
                    },
                    body: formData
                });
                if (!uploadResp.ok) throw new Error('Ошибка загрузки файла');
                const uploadData = await uploadResp.json();
                url = uploadData.uploaded_urls[0];
            }
            // Теперь обновляем запись
            const resp = await fetch(`${SiteURL}/address-file/video/${id}`, {
                method: 'PUT',
                headers: {
                    'accept': 'application/json',
                    'Authorization': `Bearer ${Token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, url, active })
            });
            if (!resp.ok) throw new Error('Ошибка изменения');
            editVideoModal.hide();
            fetchVideos();
        } catch (error) {
            alert(error.message || 'Ошибка изменения');
        }
    }

    async function deleteVideo(id) {
        if (!confirm('Удалить видео?')) return;
        try {
            const resp = await fetch(`${SiteURL}/address-file/video/${id}`, {
                method: 'DELETE',
                headers: {
                    'accept': 'application/json',
                    'Authorization': `Bearer ${Token}`
                }
            });
            if (!resp.ok) throw new Error('Ошибка удаления');
            fetchVideos();
        } catch (error) {
            alert(error.message || 'Ошибка удаления');
        }
    }

    // Превью выбранного файла в модалке
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('edit-video-file');
        const preview = document.getElementById('edit-video-preview');
        fileInput.addEventListener('change', function() {
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                preview.src = document.getElementById('edit-video-current-url').value;
            }
        });
    });

    function viewVideo(url, name) {
        document.getElementById('view-video-player').src = url;
        document.getElementById('view-video-title').textContent = name;
        viewVideoModal.show();
    }

    // Останавливать видео при закрытии модалки просмотра
    document.getElementById('viewVideoModal').addEventListener('hidden.bs.modal', function () {
        const player = document.getElementById('view-video-player');
        player.pause();
        player.currentTime = 0;
    });

    window.onload = fetchVideos;
</script>
{% endblock %}