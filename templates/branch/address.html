<!-- templates/china_address/china_address.html -->
{% extends "base.html" %}

{% block content %}
{% include 'components/nav_user_config.html' %}

        <h3 class="mb-4">Адрес склада Китай</h3>

        <!-- Сообщения -->
        <div id="successMessage" class="alert alert-success" style="display: none;"></div>
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

        <!-- Блок просмотра -->
        <div id="display-mode">
            <p id="name1"></p>
            <p id="name2"></p>
            <p id="name3"></p>
            <button id="edit-btn" class="btn btn-primary">Изменить</button>
        </div>

        <!-- Блок редактирования -->
        <div id="edit-mode" style="display: none;">
            <form id="chinaAddressForm" class="mb-3">
                <div class="mb-3">
                    <label for="name1" class="form-label">Name 1</label>
                    <input type="text" class="form-control" id="edit-name1" name="name1" required>
                </div>
                <div class="mb-3">
                    <label for="name2" class="form-label">Name 2</label>
                    <input type="text" class="form-control" id="edit-name2" name="name2" required>
                </div>
                <div class="mb-3">
                    <label for="name3" class="form-label">Name 3</label>
                    <input type="text" class="form-control" id="edit-name3" name="name3" required>
                </div>
                <button type="submit" class="btn btn-success">Сохранить</button>
                <button type="button" id="cancel-btn" class="btn btn-secondary">Отмена</button>
            </form>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SiteUrl = "{{ site_url_and_port }}";
        const token = "{{ token }}";

        // Переключение режимов
        const editBtn = document.getElementById('edit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const displayMode = document.getElementById('display-mode');
        const editMode = document.getElementById('edit-mode');

        editBtn.addEventListener('click', () => {
            displayMode.style.display = 'none';
            editMode.style.display = 'block';
        });

        cancelBtn.addEventListener('click', () => {
            displayMode.style.display = 'block';
            editMode.style.display = 'none';
            loadAddress(); // Перезагружаем данные при отмене
        });

        // Функция загрузки адреса
        async function loadAddress() {
            try {
                const response = await fetch(`${SiteUrl}/china-address/instance`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }

                const address = await response.json();
                document.getElementById("name1").textContent = address.name1 || "";
                document.getElementById("name2").textContent = address.name2 || "";
                document.getElementById("name3").textContent = address.name3 || "";
                document.getElementById("edit-name1").value = address.name1 || "";
                document.getElementById("edit-name2").value = address.name2 || "";
                document.getElementById("edit-name3").value = address.name3 || "";
            } catch (error) {
                console.error("Ошибка при загрузке адреса:", error);
                document.getElementById("errorMessage").textContent = "Не удалось загрузить данные: " + error.message;
                document.getElementById("errorMessage").style.display = "block";
            }
        }

        // Обработка отправки формы
        document.getElementById("chinaAddressForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            try {
                const response = await fetch(`${SiteUrl}/china-address/update`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    },
                    body: formData // Отправляем FormData напрямую для x-www-form-urlencoded
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Ошибка: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                document.getElementById("successMessage").textContent = "Адрес успешно обновлён!";
                document.getElementById("successMessage").style.display = "block";
                document.getElementById("errorMessage").style.display = "none";

                displayMode.style.display = 'block';
                editMode.style.display = 'none';
                loadAddress(); // Обновляем отображаемые данные
            } catch (error) {
                console.error("Ошибка при сохранении:", error);
                document.getElementById("errorMessage").textContent = error.message;
                document.getElementById("errorMessage").style.display = "block";
                document.getElementById("successMessage").style.display = "none";
            }
        });

        // Начальная загрузка данных
        loadAddress();
    </script>
{% endblock %}