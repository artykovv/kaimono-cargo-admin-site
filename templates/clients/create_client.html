<!-- templates/clients/create_client.html -->
{% extends "base.html" %}

{% block content %}
    <div class="container mt-4">

        <!-- Форма создания клиента -->
        <form id="create_client_form" class="mb-3">
            <div class="mb-3">
                <label for="name" class="form-label">ФИО</label>
                <input type="text" class="form-control" id="name" name="name">
            </div>
            <div class="mb-3">
                <label for="number" class="form-label">Номер телефона</label>
                <input type="text" class="form-control" id="number" name="number">
            </div>
            <div class="mb-3">
                <label for="city" class="form-label">Город</label>
                <input type="text" class="form-control" id="city" name="city">
            </div>
            <div class="mb-3">
                <label for="telegram_chat_id" class="form-label">Код телеграма</label>
                <input type="text" class="form-control" id="telegram_chat_id" name="telegram_chat_id">
            </div>
            <div class="mb-3">
                <label for="branch" class="form-label">Филиал</label>
                <select id="branch" name="branch_id" class="form-select">
                    <option value="">Выберите филиал</option>
                    <!-- Филиалы будут загружены через JS -->
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Добавить</button>
            <a href="/clients/" class="btn btn-secondary ms-2">Отмена</a>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SiteUrl = "{{ site_url_and_port }}";
        const token = "{{ token }}";

        // Загрузка филиалов для селекта
        async function loadBranches() {
            try {
                const response = await fetch(`${SiteUrl}/branches/?skip=0&limit=100`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });
                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }
                const data = await response.json();
                const select = document.getElementById("branch");
                data.forEach(branch => {
                    const option = document.createElement("option");
                    option.value = branch.id;
                    option.textContent = `${branch.name} ${branch.code} | ${branch.address}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Ошибка при загрузке филиалов:", error);
            }
        }

        // Обработка отправки формы
        document.getElementById("create_client_form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                name: formData.get("name") || null,
                number: formData.get("number") || null,
                city: formData.get("city") || null,
                telegram_chat_id: formData.get("telegram_chat_id") || null,
                branch_id: formData.get("branch_id") ? parseInt(formData.get("branch_id")) : null
            };

            try {
                const response = await fetch(`${SiteUrl}/clients/`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Ошибка: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                // Успешно создан, перенаправляем на список клиентов
                window.location.href = `/clients/`;
            } catch (error) {
                console.error("Ошибка при создании клиента:", error);
                alert("Не удалось создать клиента: " + error.message);
            }
        });

        // Начальная загрузка филиалов
        loadBranches();
    </script>
{% endblock %}