<!-- templates/products/update_products.html -->
{% extends "base.html" %}

{% block content %}
    <div class="container mt-4">
        <h2>Изменить товары</h2>

        <!-- Универсальная форма -->
        <form id="productsForm" class="mb-3">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Код</th>
                        <th>Вес</th>
                        <th>Цена</th>
                        <th>Дата</th>
                        <th>Статус</th>
                        <th>Клиент</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
            </table>

            <div class="mb-3">
                <label for="status_id" class="form-label">Статус</label>
                <select id="status_id" name="status_id" class="form-select">
                    <option value="">Выберите статус</option>
                    <!-- Статусы будут загружены через JS -->
                </select>
            </div>

            <div class="mt-4 d-flex gap-3">
                <button type="submit" class="btn btn-success" onclick="setFormAction('update')">Сохранить</button>
                <button type="submit" class="btn btn-danger" onclick="setFormAction('delete')">Удалить</button>
                <a href="/products/" class="btn btn-primary">Отмена</a>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SiteUrl = "{{ site_url_and_port }}";
        const token = "{{ token }}";
        const productIds = JSON.parse(localStorage.getItem("selectedProductIds") || "[]");

        // Загрузка данных товаров
        async function loadProducts() {
            if (productIds.length === 0) {
                document.getElementById("productsTableBody").innerHTML = "<tr><td colspan='7'>Нет выбранных товаров</td></tr>";
                return;
            }

            try {
                const response = await fetch(`${SiteUrl}/products/ids`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({ product_ids: productIds })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Ошибка: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                const products = await response.json();
                renderProducts(products);
            } catch (error) {
                console.error("Ошибка при загрузке товаров:", error);
                document.getElementById("productsTableBody").innerHTML = "<tr><td colspan='7'>Ошибка загрузки данных</td></tr>";
            }
        }

        // Рендеринг таблицы товаров
        function renderProducts(products) {
            const tbody = document.getElementById("productsTableBody");
            tbody.innerHTML = "";
            products.forEach(product => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${product.product_code || ""}</td>
                    <td>${product.weight || ""}</td>
                    <td>${product.price || ""}</td>
                    <td>${new Date(product.date).toLocaleDateString("ru-RU", {year: "numeric", month: "2-digit", day: "2-digit"})}</td>
                    <td>${product.status ? product.status.name : ""}</td>
                    <td>${(product.client && product.client.code) || ""}</td>
                `;
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "product_ids";
                input.value = product.id;
                tr.appendChild(input);
                tbody.appendChild(tr);
            });
        }

        // Загрузка статусов для селекта
        async function loadStatuses() {
            try {
                const response = await fetch(`${SiteUrl}/statuses/?skip=0&limit=100`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });
                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }
                const data = await response.json();
                const select = document.getElementById("status_id");
                data.forEach(status => {
                    const option = document.createElement("option");
                    option.value = status.id;
                    option.textContent = status.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Ошибка при загрузке статусов:", error);
            }
        }

        // Установка действия формы
        function setFormAction(action) {
            const form = document.getElementById("productsForm");
            form.dataset.action = action;
        }

        // Обработка отправки формы
        document.getElementById("productsForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const productIds = formData.getAll("product_ids").map(id => parseInt(id));
            const action = e.target.dataset.action;

            if (action === "update") {
                const statusId = formData.get("status_id") ? parseInt(formData.get("status_id")) : null;
                if (!statusId) {
                    alert("Выберите статус для обновления");
                    return;
                }

                try {
                    const response = await fetch(`${SiteUrl}/products/update`, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${token}`,
                            "Content-Type": "application/json",
                            "Accept": "application/json"
                        },
                        body: JSON.stringify({ product_ids: productIds, status_id: statusId })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Ошибка: ${response.status} - ${JSON.stringify(errorData)}`);
                    }

                    localStorage.removeItem("selectedProductIds");
                    window.location.href = `/products/`;
                } catch (error) {
                    console.error("Ошибка при обновлении товаров:", error);
                    alert("Не удалось обновить товары: " + error.message);
                }
            } else if (action === "delete") {
                // Перенаправляем на страницу подтверждения удаления
                localStorage.setItem("deleteProductIds", JSON.stringify(productIds));
                window.location.href = `/products/confirm-delete`;
            }
        });

        // Начальная загрузка
        loadProducts();
        loadStatuses();
    </script>
{% endblock %}