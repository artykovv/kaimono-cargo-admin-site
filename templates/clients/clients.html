{% extends "base.html" %}
{% block content %}


        <!-- Форма поиска -->
        <form id="searchForm" class="mb-3">
            <div class="d-flex justify-content-end mb-3">
                <a href="/clients/create" class="btn btn-primary" id="addClientBtn">Добавить</a>
            </div>
            <div class="d-flex mb-3">
                <input type="text" name="search" class="form-control" placeholder="Поиск по имени, номеру или коду" value="">
                <!-- <input type="number" name="branch_id" class="form-control ms-2" placeholder="ID филиала" min="1"> -->
                <select name="page_size" class="form-control ms-2">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="30" selected>30</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
                <button type="submit" class="btn btn-primary ms-2">Поиск</button>
                <a href="#" class="btn btn-secondary ms-2" id="resetBtn">Сброс</a>
            </div>
        </form>

        <!-- Таблица с клиентами -->
        <table class="table">
            <thead>
                <tr>
                    <th>Код</th>
                    <th>Имя</th>
                    <th>Номер</th>
                    <th>Город</th>
                    <th>Дата регистрации</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="clientsTableBody"></tbody>
        </table>

        <!-- Пагинация -->
        <nav aria-label="Page navigation">
            <ul class="pagination" id="pagination"></ul>
        </nav>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SiteUrl = "{{ site_url_and_port }}";
        const token = "{{ token }}";

        // Параметры запроса
        let params = {
            search: "",
            branch_id: "",
            page: 1,
            page_size: 30
        };

        // Функция построения строки запроса
        function buildQueryString(params) {
            const usp = new URLSearchParams();
            if (params.search) usp.set("search", params.search);
            if (params.branch_id) usp.set("branch_id", params.branch_id);
            usp.set("page", params.page);
            usp.set("page_size", params.page_size);
            return usp.toString();
        }

        // Загрузка клиентов
        async function loadClients() {
            const queryString = buildQueryString(params);
            try {
                const response = await fetch(`${SiteUrl}/clients/?${queryString}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }

                const data = await response.json();
                renderClients(data);
            } catch (error) {
                console.error("Ошибка при загрузке клиентов:", error);
                document.getElementById("clientsTableBody").innerHTML = "<tr><td colspan='6'>Ошибка загрузки данных</td></tr>";
            }
        }

        // Рендеринг таблицы клиентов
        function renderClients(data) {
            const tbody = document.getElementById("clientsTableBody");
            tbody.innerHTML = "";

            data.clients.forEach(client => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${client.code || ""}</td>
                    <td>${client.name || ""}</td>
                    <td>${client.number || ""}</td>
                    <td>${client.city || ""}</td>
                    <td>${new Date(client.registered_at).toLocaleString()}</td>
                    <td>
                        <a href="/clients/${client.id}/edit" class="btn btn-sm btn-warning">U</a>
                        <a href="/clients/${client.id}" class="btn btn-sm btn-danger">D</a>
                        <a href="/clients/${client.id}/detail" class="btn btn-sm btn-primary">T</a>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            renderPagination(data);
        }

        // Рендеринг пагинации
        function renderPagination(data) {
            const pagination = document.getElementById("pagination");
            pagination.innerHTML = "";

            const firstLi = document.createElement("li");
            firstLi.className = `page-item ${data.page === 1 ? "disabled" : ""}`;
            firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">«</a>`;
            pagination.appendChild(firstLi);

            const prevLi = document.createElement("li");
            prevLi.className = `page-item ${data.page === 1 ? "disabled" : ""}`;
            prevLi.innerHTML = `<a class="page-link" href="#" data-page="${data.page - 1}">‹</a>`;
            pagination.appendChild(prevLi);

            const startPage = Math.max(1, data.page - 4);
            const endPage = Math.min(data.total_pages, data.page + 4);
            for (let i = startPage; i <= endPage; i++) {
                const li = document.createElement("li");
                li.className = `page-item ${i === data.page ? "active" : ""}`;
                li.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
                pagination.appendChild(li);
            }

            const nextLi = document.createElement("li");
            nextLi.className = `page-item ${data.page === data.total_pages ? "disabled" : ""}`;
            nextLi.innerHTML = `<a class="page-link" href="#" data-page="${data.page + 1}">›</a>`;
            pagination.appendChild(nextLi);

            const lastLi = document.createElement("li");
            lastLi.className = `page-item ${data.page === data.total_pages ? "disabled" : ""}`;
            lastLi.innerHTML = `<a class="page-link" href="#" data-page="${data.total_pages}">»</a>`;
            pagination.appendChild(lastLi);

            pagination.querySelectorAll(".page-link").forEach(link => {
                link.addEventListener("click", (e) => {
                    e.preventDefault();
                    const page = parseInt(e.target.dataset.page);
                    if (page && page !== params.page) {
                        params.page = page;
                        loadClients();
                    }
                });
            });
        }

        // Обработка формы поиска
        document.getElementById("searchForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            params.search = formData.get("search") || "";
            params.branch_id = formData.get("branch_id") || "";
            params.page_size = parseInt(formData.get("page_size")) || 30;
            params.page = 1;
            loadClients();
        });

        // Сброс фильтров
        document.getElementById("resetBtn").addEventListener("click", (e) => {
            e.preventDefault();
            params.search = "";
            params.branch_id = "";
            params.page = 1;
            params.page_size = 30;
            document.querySelector("input[name='search']").value = "";
            // document.querySelector("input[name='branch_id']").value = "";
            document.querySelector("select[name='page_size']").value = "30";
            loadClients();
        });

        // Начальная загрузка
        loadClients();
    </script>
{% endblock %}