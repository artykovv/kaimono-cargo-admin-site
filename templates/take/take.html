<!-- templates/take/take.html -->
{% extends "base.html" %}

{% block content %}
    <div class="container mt-5">
        <h4 class="mb-3">Выдача товаров клиенту</h4>

        <!-- Поиск -->
        <form id="searchForm" class="d-flex mb-3">
            <input type="text" name="client_code" class="form-control" placeholder="Введите код клиента" value="">
            <button type="submit" class="btn btn-primary ms-2">Поиск</button>
        </form>

        <!-- Сообщения -->
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

        <!-- Отчет по клиентам к выдаче -->
        <div class="table-responsive">
            <table class="table align-middle">
                <thead>
                    <tr>
                        <th>Код клиента</th>
                        <th>Товаров</th>
                        <th>Сумма</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="reportTableBody"></tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SiteUrl = "{{ site_url_and_port }}";
        const token = "{{ token }}";

        let reportData = [];

        async function fetchReport() {
            try {
                const response = await fetch(`${SiteUrl}/take/report`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });
                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }
                reportData = await response.json();
                const params = new URLSearchParams(window.location.search);
                const q = params.get("client_code") || "";
                if (q) {
                    document.querySelector("input[name='client_code']").value = q;
                }
                renderReport(applyFilter(q));
            } catch (error) {
                console.error("Ошибка при загрузке отчета:", error);
                const errorDiv = document.getElementById("errorMessage");
                errorDiv.textContent = "Не удалось загрузить отчет: " + error.message;
                errorDiv.style.display = "block";
            }
        }

        function renderReport(items) {
            const tbody = document.getElementById("reportTableBody");
            tbody.innerHTML = "";
            if (!items || items.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4'>Нет данных</td></tr>";
                return;
            }
            items.forEach(item => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.code}</td>
                    <td>${item.product_count}</td>
                    <td>${item.total_product_price}</td>
                    <td class="text-end"><a class="btn btn-success btn-sm" href="/take/${item.code}">Выдать</a></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function applyFilter(query) {
            const q = (query || "").trim().toLowerCase();
            if (!q) return reportData;
            return reportData.filter(r => (r.code || "").toLowerCase().includes(q));
        }

        document.getElementById("searchForm").addEventListener("submit", (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const q = (formData.get("client_code") || "").trim();
            if (q) {
                window.location.href = `/take/${q}`;
                return;
            }
        });

        fetchReport();
    </script>
{% endblock %}