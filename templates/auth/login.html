<title>Войти</title>
<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
  crossorigin="anonymous"
/>

<div class="d-flex align-items-center justify-content-center" style="height: 90vh;">
  <div class="col-sm-3">
    <form id="login-form" method="post">

      <h3 class="fw-normal mb-3 pb-3" style="letter-spacing: 1px;">Войти</h3>

      <!-- Сообщения об ошибках -->
      <div id="error-message" class="alert alert-danger" style="display: none;" role="alert"></div>

      <div data-mdb-input-init class="form-outline mb-4">
        <input type="email" id="email" name="email" class="form-control form-control-lg" />
        <label class="form-label" for="form2Example18">Имя пользователя</label>
      </div>

      <div data-mdb-input-init class="form-outline mb-4">
        <input type="password" name="password" id="password" class="form-control form-control-lg" />
        <label class="form-label" for="form2Example28">Пароль</label>
      </div>

      <div class="pt-1 mb-4">
        <button class="btn btn-primary btn-lg btn-block" type="submit">Войти</button>
      </div>
    </form>
  </div>
</div>


<div id="alertContainer" class="mt-3"></div>

<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
  crossorigin="anonymous">
</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('login-form');
      const alertContainer = document.getElementById('alertContainer');
      const SiteUrl = "{{ site_url_and_port }}";

      form.addEventListener('submit', async (event) => {
          event.preventDefault();

          // Получаем данные из полей формы
          const email = document.getElementById('email').value;
          const password = document.getElementById('password').value;

          try {
              // Отправляем запрос на сервер
              const response = await fetch(`${SiteUrl}/auth/jwt/login`, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                      'Accept': 'application/json',
                  },
                  body: new URLSearchParams({
                      grant_type: 'password',
                      username: email,
                      password: password,
                  }),
              });

              const data = await response.json();
              console.log(data)

              // Очищаем предыдущие алерты
              alertContainer.innerHTML = '';

              if (response.ok) {
                  // Добавляем success alert
                  alertContainer.innerHTML = `
                      <div class="alert alert-success" role="alert">
                          Успешный вход! Перенаправляем...
                      </div>
                  `;

                  // Сохраняем токен в куки как Bearer
                  // document.cookie = `Bearer=${data.access_token}; path=/; secure; HttpOnly;`;
                  document.cookie = `Bearer=${data.access_token}; path=/;`;
                  console.log(document.cookie);

                  // Перенаправляем на главную страницу через 2 секунды
                  setTimeout(() => {
                      window.location.href = '/';
                  }, 2000);
              } else {
                  // Добавляем danger alert с сообщением от сервера
                  alertContainer.innerHTML = `
                      <div class="alert alert-danger" role="alert">
                          Ошибка авторизации: ${data.detail || 'Неизвестная ошибка'}
                      </div>
                  `;
              }
          } catch (error) {
              console.error('Ошибка:', error);
              // Добавляем alert об ошибке
              alertContainer.innerHTML = `
                  <div class="alert alert-danger" role="alert">
                      Ошибка соединения с сервером.
                  </div>
              `;
          }
      });
  });

</script>