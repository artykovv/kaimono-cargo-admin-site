<!-- templates/users/users.html -->
{% extends "base.html" %}

{% block content %}
{% include 'components/nav_user_config.html' %}
        
        <h3 class="mb-4">Пользователи</h3>

        <!-- Сообщения -->
        <div id="successMessage" class="alert alert-success" style="display: none;"></div>
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

        <div class="d-flex justify-content-between mb-3">
            <a href="/users/create" class="btn btn-primary">Добавить</a>
        </div>

        <table class="table">
            <thead>
                <tr>

                    <th>ФИО</th>
                    <th>Электронная Почта</th>
                    <th>Активный</th>
                    <th>Суперпользователь</th>
                    <th>Филиал</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="usersBody"></tbody>
        </table>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SiteUrl = "{{ site_url_and_port }}";
        const token = "{{ token }}";

        // Функция загрузки пользователей
        async function loadUsers() {
            try {
                const response = await fetch(`${SiteUrl}/users/?skip=0&limit=100`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }

                const users = await response.json();
                renderUsers(users);
            } catch (error) {
                console.error("Ошибка при загрузке пользователей:", error);
                document.getElementById("usersBody").innerHTML = "<tr><td colspan='7'>Ошибка загрузки данных</td></tr>";
                document.getElementById("errorMessage").textContent = "Не удалось загрузить данные: " + error.message;
                document.getElementById("errorMessage").style.display = "block";
            }
        }

        // Рендеринг списка пользователей
        function renderUsers(users) {
            const tbody = document.getElementById("usersBody");
            tbody.innerHTML = "";

            if (users && users.length > 0) {
                users.forEach(user => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `

                        <td>${(user.name || "") + " " + (user.lastname || "")}</td>
                        <td>${user.email || ""}</td>
                        <td><input class="form-check-input" type="checkbox" ${user.is_active ? "checked" : ""} disabled></td>
                        <td><input class="form-check-input" type="checkbox" ${user.is_superuser ? "checked" : ""} disabled></td>
                        <td>${user.branch_ids && user.branch_ids.length > 0 ? user.branch_ids.join(", ") : "—"}</td>
                        <td class="text-center">
                            <a href="${SiteUrl}/users/edit/${user.id}" class="btn btn-sm btn-warning">U</a>
                            <button onclick="deleteUser('${user.id}')" class="btn btn-sm btn-danger">D</button>
                            <a href="${SiteUrl}/users/branches/${user.id}" class="btn btn-sm btn-info">B</a>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = "<tr><td colspan='7'>Нет пользователей.</td></tr>";
            }
        }

        // Функция удаления пользователя
        async function deleteUser(userId) {
            if (!confirm("Вы уверены, что хотите удалить этого пользователя?")) return;

            try {
                const response = await fetch(`${SiteUrl}/users/${userId}`, {
                    method: "DELETE",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Ошибка: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                document.getElementById("successMessage").textContent = "Пользователь успешно удалён!";
                document.getElementById("successMessage").style.display = "block";
                document.getElementById("errorMessage").style.display = "none";

                loadUsers(); // Перезагружаем список
            } catch (error) {
                console.error("Ошибка при удалении:", error);
                document.getElementById("errorMessage").textContent = error.message;
                document.getElementById("errorMessage").style.display = "block";
                document.getElementById("successMessage").style.display = "none";
            }
        }

        // Начальная загрузка
        loadUsers();
    </script>
{% endblock %}