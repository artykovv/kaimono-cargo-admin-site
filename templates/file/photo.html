{% extends "base.html" %}

{% block content %}
{% include 'components/nav_user_config.html' %}

<div class="container mt-4">
    <!-- Add Photo Form -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>Добавить фото</h5>
        </div>
        <div class="card-body">
            <form id="add-photo-form" enctype="multipart/form-data" onsubmit="return false;">
                <div class="row g-2 align-items-center">
                    <div class="col-md-4">
                        <input type="text" id="photo-name" class="form-control" placeholder="Имя фото" required>
                    </div>
                    <div class="col-md-4">
                        <input type="file" id="photo-file" class="form-control" accept="image/*" required>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="addPhoto()">Добавить</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Photo List -->
    <div class="card">
        <div class="card-header">
            <h5>Список фото</h5>
        </div>
        <div class="card-body p-0">
            <div id="list-photos" class="list-group list-group-flush"></div>
        </div>
    </div>
</div>

<!-- Edit Photo Modal -->
<div class="modal fade" id="editPhotoModal" tabindex="-1" aria-labelledby="editPhotoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editPhotoModalLabel">Изменить фото</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-photo-form" enctype="multipart/form-data" onsubmit="return false;">
          <input type="hidden" id="edit-photo-id">
          <input type="hidden" id="edit-photo-current-url">
          <div class="mb-3">
            <label for="edit-photo-name" class="form-label">Имя</label>
            <input type="text" class="form-control" id="edit-photo-name" required>
          </div>
          <div class="mb-3">
            <label for="edit-photo-file" class="form-label">Заменить файл (необязательно)</label>
            <input type="file" class="form-control" id="edit-photo-file" accept="image/*">
          </div>
          <div class="mb-3">
            <img id="edit-photo-preview" src="" alt="preview" style="max-width:100px;max-height:100px;border:1px solid #eee;">
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="edit-photo-active">
            <label class="form-check-label" for="edit-photo-active">Активно</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" onclick="submitEditPhoto()">Сохранить</button>
      </div>
    </div>
  </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const SiteURL = "{{site_url_and_port}}";
    const Token = "{{token}}";
    let editPhotoModal;
    document.addEventListener('DOMContentLoaded', function() {
        editPhotoModal = new bootstrap.Modal(document.getElementById('editPhotoModal'));
    });

    async function fetchPhotos() {
        try {
            const response = await fetch(`${SiteURL}/address-file/photo`, {
                method: 'GET',
                headers: {
                    'accept': 'application/json',
                    'Authorization': `Bearer ${Token}`
                }
            });
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            const container = document.getElementById('list-photos');
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<div class="p-3 text-muted">Нет фото</div>';
                return;
            }
            data.forEach(item => {
                const listItem = document.createElement('div');
                listItem.className = 'list-group-item d-flex align-items-center justify-content-between';
                listItem.innerHTML = `
                    <div class="d-flex align-items-center gap-3">
                        <img src="${item.url}" alt="${item.name}" style="width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #eee;">
                        <span>${item.name}</span>
                        ${item.active ? '<span class="badge bg-success">active</span>' : ''}
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editPhoto(${item.id}, '${item.name.replace(/'/g, "&#39;")}', '${item.url}', ${item.active})">Изменить</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePhoto(${item.id})">Удалить</button>
                    </div>
                `;
                container.appendChild(listItem);
            });
        } catch (error) {
            const container = document.getElementById('list-photos');
            container.innerHTML = '<div class="alert alert-danger">Ошибка загрузки фото</div>';
        }
    }

    async function addPhoto() {
        const nameInput = document.getElementById('photo-name');
        const fileInput = document.getElementById('photo-file');
        const name = nameInput.value.trim();
        const file = fileInput.files[0];
        if (!name || !file) {
            alert('Заполните имя и выберите файл');
            return;
        }
        try {
            // 1. Upload file
            const formData = new FormData();
            formData.append('files', file);
            const uploadResp = await fetch(`${SiteURL}/storage/upload`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${Token}`
                },
                body: formData
            });
            if (!uploadResp.ok) throw new Error('Ошибка загрузки файла');
            const uploadData = await uploadResp.json();
            const url = uploadData.uploaded_urls[0];
            // 2. Add photo record
            const addResp = await fetch(`${SiteURL}/address-file/photo`, {
                method: 'POST',
                headers: {
                    'accept': 'application/json',
                    'Authorization': `Bearer ${Token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, url })
            });
            if (!addResp.ok) throw new Error('Ошибка добавления фото');
            nameInput.value = '';
            fileInput.value = '';
            fetchPhotos();
        } catch (error) {
            alert(error.message || 'Ошибка добавления');
        }
    }

    function editPhoto(id, currentName, currentUrl, currentActive = true) {
        document.getElementById('edit-photo-id').value = id;
        document.getElementById('edit-photo-name').value = currentName;
        document.getElementById('edit-photo-current-url').value = currentUrl;
        document.getElementById('edit-photo-preview').src = currentUrl;
        document.getElementById('edit-photo-file').value = '';
        document.getElementById('edit-photo-active').checked = currentActive;
        editPhotoModal.show();
    }

    async function submitEditPhoto() {
        const id = document.getElementById('edit-photo-id').value;
        const name = document.getElementById('edit-photo-name').value.trim();
        const fileInput = document.getElementById('edit-photo-file');
        const file = fileInput.files[0];
        let url = document.getElementById('edit-photo-current-url').value;
        const active = document.getElementById('edit-photo-active').checked;
        if (!name) {
            alert('Имя обязательно');
            return;
        }
        try {
            if (file) {
                // Сначала загружаем новый файл
                const formData = new FormData();
                formData.append('files', file);
                const uploadResp = await fetch(`${SiteURL}/storage/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${Token}`
                    },
                    body: formData
                });
                if (!uploadResp.ok) throw new Error('Ошибка загрузки файла');
                const uploadData = await uploadResp.json();
                url = uploadData.uploaded_urls[0];
            }
            // Теперь обновляем запись
            const resp = await fetch(`${SiteURL}/address-file/photo/${id}`, {
                method: 'PUT',
                headers: {
                    'accept': 'application/json',
                    'Authorization': `Bearer ${Token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, url, active })
            });
            if (!resp.ok) throw new Error('Ошибка изменения');
            editPhotoModal.hide();
            fetchPhotos();
        } catch (error) {
            alert(error.message || 'Ошибка изменения');
        }
    }

    async function deletePhoto(id) {
        if (!confirm('Удалить фото?')) return;
        try {
            const resp = await fetch(`${SiteURL}/address-file/photo/${id}`, {
                method: 'DELETE',
                headers: {
                    'accept': 'application/json',
                    'Authorization': `Bearer ${Token}`
                }
            });
            if (!resp.ok) throw new Error('Ошибка удаления');
            fetchPhotos();
        } catch (error) {
            alert(error.message || 'Ошибка удаления');
        }
    }

    // Превью выбранного файла в модалке
    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('edit-photo-file');
        const preview = document.getElementById('edit-photo-preview');
        fileInput.addEventListener('change', function() {
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                preview.src = document.getElementById('edit-photo-current-url').value;
            }
        });
    });

    window.onload = fetchPhotos;
</script>
{% endblock %}