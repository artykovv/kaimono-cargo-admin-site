<!-- templates/branches/branches.html -->
{% extends "base.html" %}

{% block content %}
{% include 'components/nav_user_config.html' %}
        
        <h3 class="mb-4">Филиалы</h3>

        <!-- Сообщения -->
        <div id="successMessage" class="alert alert-success" style="display: none;"></div>
        <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

        <div class="d-flex justify-content-between mb-3">
            <a href="/branch/create" class="btn btn-primary">Добавить</a>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>Имя</th>
                    <th>Код</th>
                    <th>Адрес</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="branchesBody"></tbody>
        </table>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SiteUrl = "{{ site_url_and_port }}";
        const token = "{{ token }}";

        // Функция загрузки филиалов
        async function loadBranches() {
            try {
                const response = await fetch(`${SiteUrl}/branches/?skip=0&limit=100`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });

                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }

                const branches = await response.json();
                renderBranches(branches);
            } catch (error) {
                console.error("Ошибка при загрузке филиалов:", error);
                document.getElementById("branchesBody").innerHTML = "<tr><td colspan='4'>Ошибка загрузки данных</td></tr>";
            }
        }

        // Рендеринг списка филиалов
        function renderBranches(branches) {
            const tbody = document.getElementById("branchesBody");
            tbody.innerHTML = "";

            if (branches && branches.length > 0) {
                branches.forEach(branch => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${branch.name || ""}</td>
                        <td>${branch.code || ""}</td>
                        <td>${branch.address || ""}</td>
                        <td class="text-center">
                            <a href="/branches/edit/${branch.id}" class="btn btn-sm btn-warning">U</a>
                            <button onclick="deleteBranch(${branch.id})" class="btn btn-sm btn-danger">D</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                tbody.innerHTML = "<tr><td colspan='4'>Нет филиалов.</td></tr>";
            }
        }

        // Функция удаления филиала
        async function deleteBranch(branchId) {
            if (!confirm("Вы уверены, что хотите удалить этот филиал?")) return;

            try {
                const response = await fetch(`${SiteUrl}/branches/${branchId}`, {
                    method: "DELETE",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Ошибка: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                document.getElementById("successMessage").textContent = "Филиал успешно удалён!";
                document.getElementById("successMessage").style.display = "block";
                document.getElementById("errorMessage").style.display = "none";

                loadBranches(); // Перезагружаем список
            } catch (error) {
                console.error("Ошибка при удалении:", error);
                document.getElementById("errorMessage").textContent = error.message;
                document.getElementById("errorMessage").style.display = "block";
                document.getElementById("successMessage").style.display = "none";
            }
        }

        // Начальная загрузка
        loadBranches();
    </script>
{% endblock %}