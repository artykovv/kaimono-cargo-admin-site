<!-- templates/products/edit_product.html -->
{% extends "base.html" %}

{% block content %}
    <div class="container mt-4">
        <h2>Редактировать товар</h2>

        <!-- Форма редактирования товара -->
        <form id="edit_product_form" class="mb-3">
            <div class="mb-3">
                <label for="product_code" class="form-label">Код товара</label>
                <input type="text" class="form-control" id="product_code" name="product_code">
            </div>
            <div class="mb-3">
                <label for="weight" class="form-label">Вес</label>
                <input type="number" class="form-control" id="weight" name="weight" step="0.01">
            </div>
            <div class="mb-3">
                <label for="price" class="form-label">Цена</label>
                <input type="number" class="form-control" id="price" name="price">
            </div>
            <div class="mb-3">
                <label for="date" class="form-label">Дата</label>
                <input type="date" class="form-control" id="date" name="date">
            </div>
            <div class="mb-3">
                <label for="status_id" class="form-label">Статус</label>
                <select class="form-select" id="status_id" name="status_id">
                    <option value="">Выберите статус</option>
                    <!-- Статусы будут загружены через JS -->
                </select>
            </div>
            <div class="mb-3">
                <label for="branch_id" class="form-label">Филиал</label>
                <select class="form-select" id="branch_id" name="branch_id">
                    <option value="">Выберите филиал</option>
                    <!-- Филиалы будут загружены через JS -->
                </select>
            </div>
            <div class="mb-3">
                <label for="client_code" class="form-label">Код клиента</label>
                <input type="text" class="form-control" id="client_code" name="client_code">
            </div>
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="/products/" class="btn btn-secondary ms-2">Отмена</a>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const SiteUrl = "{{ site_url_and_port }}";
        const token = "{{ token }}";
        const productId = window.location.pathname.split('/')[3]; // Извлекаем ID из URL (/products/2)

        let originalData = {}; // Храним исходные данные товара для сравнения

        // Загрузка данных товара
        async function loadProduct() {
            try {
                const response = await fetch(`${SiteUrl}/products/${productId}`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });
                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }
                const product = await response.json();
                originalData = product;
                document.getElementById("product_code").value = product.product_code || "";
                document.getElementById("weight").value = product.weight || "";
                document.getElementById("price").value = product.price || "";
                document.getElementById("date").value = product.date || "";
                document.getElementById("status_id").value = product.status_id || "";
                document.getElementById("branch_id").value = product.branch_id || "";
                document.getElementById("client_code").value = (product.client && product.client.code) || ""; // Предполагаем, что API возвращает client_code
            } catch (error) {
                console.error("Ошибка при загрузке товара:", error);
                alert("Не удалось загрузить данные товара");
            }
        }

        // Загрузка статусов для селекта
        async function loadStatuses() {
            try {
                const response = await fetch(`${SiteUrl}/statuses/?skip=0&limit=100`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });
                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }
                const data = await response.json();
                const select = document.getElementById("status_id");
                data.forEach(status => {
                    const option = document.createElement("option");
                    option.value = status.id;
                    option.textContent = status.name;
                    if (originalData.status_id === status.id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Ошибка при загрузке статусов:", error);
            }
        }

        // Загрузка филиалов для селекта
        async function loadBranches() {
            try {
                const response = await fetch(`${SiteUrl}/branches/?skip=0&limit=100`, {
                    method: "GET",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Accept": "application/json"
                    }
                });
                if (!response.ok) {
                    throw new Error(`Ошибка: ${response.status}`);
                }
                const data = await response.json();
                const select = document.getElementById("branch_id");
                data.forEach(branch => {
                    const option = document.createElement("option");
                    option.value = branch.id;
                    option.textContent = branch.name;
                    if (originalData.branch_id === branch.id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Ошибка при загрузке филиалов:", error);
            }
        }

        // Обработка отправки формы
        document.getElementById("edit_product_form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const currentData = {
                product_code: formData.get("product_code") || null,
                weight: formData.get("weight") ? parseFloat(formData.get("weight")) : null,
                price: formData.get("price") ? parseInt(formData.get("price")) : null,
                date: formData.get("date") || null,
                status_id: formData.get("status_id") ? parseInt(formData.get("status_id")) : null,
                branch_id: formData.get("branch_id") ? parseInt(formData.get("branch_id")) : null,
                client_code: formData.get("client_code") || null
            };

            // Сравниваем с исходными данными и отправляем только изменённые поля
            const changedData = {};
            Object.keys(currentData).forEach(key => {
                if (currentData[key] !== originalData[key]) {
                    changedData[key] = currentData[key];
                }
            });

            if (Object.keys(changedData).length === 0) {
                alert("Нет изменений для сохранения");
                return;
            }

            try {
                const response = await fetch(`${SiteUrl}/products/${productId}`, {
                    method: "PATCH",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(changedData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Ошибка: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                // Успешно обновлено, перенаправляем на список товаров
                window.location.href = `/products/`;
            } catch (error) {
                console.error("Ошибка при обновлении товара:", error);
                alert("Не удалось обновить товар: " + error.message);
            }
        });

        // Начальная загрузка
        loadProduct();
        loadStatuses();
        loadBranches();
    </script>
{% endblock %}